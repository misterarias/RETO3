---
version: '2'
services:
    db:
        build: ./DB
        ports:
            - 3306:3306
        expose:
            - 3306
        environment:
            MYSQL_ROOT_PASSWORD: passwd
        volumes_from:
            - stats_data

    server:
        build: ./server_node
        ports:
            - 8888:80
        links:
            - db:reto1db
            - zookeeper:zk
        expose:
            - 80
        volumes_from:
            - stats_data

    tsung:
        build: ./load
        links:
            - server:reto1server
        expose:
            - 80
        ports:
            - 10080:80
        environment:
            RATE: 10
            HITS: 10

    logstash:
        build: ./logstash
        links:
            - elastic:retoelasticsearch
        volumes_from:
            - stats_data

    elastic:
        image: elasticsearch
        ports:
            - 9200:9200
            - 9300:9300
        expose:
            - 9200
            - 9300
        volumes_from:
            - elasticsearch_data
        command:
            "elasticsearch"

    kibana:
        image: kibana
        links:
            - elastic:elasticsearch
        expose:
            - 5601
        ports:
            - 5601:5601

    zookeeper:
        image: wurstmeister/zookeeper
        ports:
            - "2181:2181"
        expose:
            - 2181
    kafka:
        image: wurstmeister/kafka
        expose:
            - 9092
        depends_on:
            - zookeeper
        links:
            - zookeeper:zk
        environment:
            HOSTNAME_COMMAND: "ifconfig  eth0 | egrep -o 'inet addr:[0-9.]*' | cut -d: -f2 | tr -d ' '"
            KAFKA_ADVERTISED_PORT: 9092
            KAFKA_AUTO_CREATE_TOPIC_ENABLE: 'true'
            KAFKA_ZOOKEEPER_CONNECT: zk:2181
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock

    # data-only volumes
    elasticsearch_data:
        image: busybox
        volumes:
            - ./data:/usr/share/elasticsearch/data

    stats_data:
        image: busybox
        volumes:
            - ./shared:/shared
